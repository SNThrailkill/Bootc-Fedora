variables:
  BUILD_TYPE:
    value: none
    options: 
      - "none"
      - "ami"
      - "qcow2"
      - "vmdk"
      - "anaconda-iso"
      - "raw"
      - "vhd"
      - "gce"
    description: "The image type to build"


.registry-login:
  before_script:
    - cp ${REGISTRY_CONF} ./auth.json
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

build-base:
  image: docker:27
  stage: build
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE
  extends: .registry-login
  script:
    - docker build -f Containerfile --target base -t $IMAGE_TAG/base:latest .
    - docker push $IMAGE_TAG/base:latest

build-nginx:
  image: docker:27
  stage: build
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE
  extends: .registry-login
  script:
    - docker build -f Containerfile --target nginx -t $IMAGE_TAG/nginx:latest .
    - docker push $IMAGE_TAG/nginx:latest

build-k3s-agent:
  image: docker:27
  stage: build
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE
  extends: .registry-login
  script:
    - docker build -f Containerfile --target k3s-agent --build-arg K3S_TOKEN=$K3S_TOKEN -t $IMAGE_TAG/k3s-agent:latest .
    - docker push $IMAGE_TAG/k3s-agent:latest

build-image:
  image: quay.io/podman/stable
  stage: build
  extends: .registry-login
  script:
    - podman run --privileged --security-opt label=type:unconfined_t \
    - -v $(pwd)/output:/output \
    - -v /var/lib/containers/storage:/var/lib/containers/storage \
    - quay.io/centos-bootc/bootc-image-builder:latest \
    - --type $BUILD_TYPE \
    - registry.gitlab.com/localthrailkill/bootc-fedora/base:latest
  rules:
    - if: $BUILD_TYPE != "none"
  artifacts:
    paths:
      - $(pwd)/output/*