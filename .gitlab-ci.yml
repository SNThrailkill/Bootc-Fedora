variables:
  BUILD_IMAGE:
    value: none
    options: 
      - "none"
      - "ami"
      - "qcow2"
      - "vmdk"
      - "anaconda-iso"
      - "raw"
      - "vhd"
      - "gce"
    description: "The image type to build"


podman-login:
  before_script:
    - cp ${REGISTRY_CONF} ./auth.json
    - podman login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

build-base:
  image: quay.io/podman/stable
  stage: build
  services:
    - quay.io/podman/stable
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE
  extends: podman-login
  script:
    - podman build -f Containerfile --target base -t $IMAGE_TAG/base:latest .
    - podman push $IMAGE_TAG/base:latest

build-nginx:
  image: quay.io/podman/stable
  stage: build
  services:
    - quay.io/podman/stable
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE
  extends: podman-login
  script:
    - podman build -f Containerfile --target nginx -t $IMAGE_TAG/nginx:latest .
    - podman push $IMAGE_TAG/nginx:latest

build-image:
  image: quay.io/podman/stable
  stage: build
  services:
    - quay.io/podman/stable
  script:
    - sudo podman run \
    - --rm \
    - -it \
    - --privileged \
    - --pull=newer \
    - --security-opt label=type:unconfined_t \
    - -v $(pwd)/output:/output \
    - -v /var/lib/containers/storage:/var/lib/containers/storage \
    - quay.io/centos-bootc/bootc-image-builder:latest \
    - --type $BUILD_IMAGE \
    - --local \
    - quay.io/fedora/fedora-bootc:40
  rules:
    - if: $BUILD_IMAGE != "none"
